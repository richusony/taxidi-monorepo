generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Users {
  id        String  @id @default(uuid())
  firstname String
  lastname  String?
  email     String  @unique
  phone     String? @unique
  password String

  role Role[]

  vehicles Vehicles[]
  bookings Bookings[]
  reviews Reviews[]
  wallet   Wallet?
  refresh_token RefreshToken[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])

  @@map("users")
}

model Vehicles {
  id                          String   @id @default(uuid())

  brand                       String
  model                       String

  kilometers_driven           Int
  vehicle_age                 Int
  mileage                     Float

  owner_id                    String
  owner                       Users    @relation(fields: [owner_id], references: [id])

  is_blocked                  Boolean  @default(false)

  price_per_hour_subunits     BigInt
  price_per_week_subunits     BigInt

  pickup_location_id          String
  pickup_location             Locations @relation(fields: [pickup_location_id], references: [id])

  current_status              VehicleStatus @default(AVAILABLE)

  bookings                    Bookings[]
  reviews                     Reviews[]

  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt

  @@index([owner_id])
  @@map("vehicles")
}

model Locations {
  id          String   @id @default(uuid())

  address     String
  latitude    String
  longitude   String

  vehicles    Vehicles[]

  createdAt   DateTime @default(now())

  @@map("locations")
}

model Bookings {
  id                      String   @id @default(uuid())

  customer_id             String
  customer                Users    @relation(fields: [customer_id], references: [id])

  vehicle_id              String
  vehicle                 Vehicles @relation(fields: [vehicle_id], references: [id])

  start_date              DateTime
  end_date                DateTime

  total_price_subunits    BigInt

  status                  BookingStatus @default(PENDING)

  payment                 Payments?

  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@index([customer_id])
  @@index([vehicle_id])
  @@index([status])

  @@map("bookings") // This tells Prisma: Call it "Booking" in TS, but "bookings" in Postgres
}

model Payments {
  id                      String   @id @default(uuid())

  booking_id              String   @unique
  booking                 Bookings @relation(fields: [booking_id], references: [id])

  amount_subunits         BigInt

  status                  PaymentStatus @default(PENDING)

  gateway_transaction_id  String?

  createdAt               DateTime @default(now())

  @@map("payments")
}

model Wallet {
  id              String   @id @default(uuid())

  user_id         String   @unique
  user            Users    @relation(fields: [user_id], references: [id])

  balance         BigInt   @default(0)

  transactions    WalletTransactions[]

  createdAt       DateTime @default(now())

  @@map("wallet")
}

model WalletTransactions {
  id              String   @id @default(uuid())

  wallet_id       String
  wallet          Wallet   @relation(fields: [wallet_id], references: [id])

  amount          BigInt

  type            WalletTxnType

  reference_id    String?   // booking / payout / refund etc

  createdAt       DateTime @default(now())

  @@index([wallet_id])

  @@map("wallet_transactions")
}

model Reviews {
  id              String   @id @default(uuid())

  vehicle_id      String
  vehicle         Vehicles @relation(fields: [vehicle_id], references: [id])

  customer_id     String
  customer        Users    @relation(fields: [customer_id], references: [id])

  rating          Int
  comment         String?

  createdAt       DateTime @default(now())

  @@map("reviews")
}

model RefreshToken {
  id         String   @id @default(uuid())
  tokenHash  String   @unique
  userId     String
  user       Users    @relation(fields: [userId], references: [id])
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  revoked    Boolean  @default(false)

  @@index([tokenHash])

  @@map("refresh_token")
}


// enums

enum Role {
  CUSTOMER
  PARTNER
  ADMIN
}

enum VehicleStatus {
  AVAILABLE
  BOOKED
  MAINTENANCE
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

enum WalletTxnType {
  CREDIT
  DEBIT
}
